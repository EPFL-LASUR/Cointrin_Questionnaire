# Regrouping
This notebook regroups the variable in a more usable way. This notebook should be ran on the cleaned dataset from the data cleaning notebook.

## Load cleaned data
This code block loads the data, paths and functions used in this notebook.
```{r}
here::i_am(file.path("notebook", "data_cleaning.Rmd"))
source(here::here(file.path("R", "regrouping.R")))

processed_data_folder <- file.path("..", "data", "processed")
raw_data_folder <- file.path("..", "data", "raw")

data <- haven::read_sav(
  file.path(
    processed_data_folder, "cleaned_data.sav"
  )
)
```


## Regrouping
This code block regroups answers of some questions. For example, we changed the age groups for v_14.
```{r}
regrouping_dict = list(
  "v_6" = list(
    "Ailes" = c(1),
    "Sapins" = c(2),
    "Jonc" = c(3),
    "Marais" = c(4),
    "VernierCointrin" = c(5),
    "Autres" = c(6)
  ),
  "v_14" = list(
    "Moins de 25 ans" = c(1, 2, 3),
    "26 - 44 ans" = c(4),
    "45- 64 ans" = c(5),
    "65 ans et plus" = c(6, 7)
  ),
  "v_15" = list(
    "Propriétaire" = c(1),
    "Locataire" = c(2, 3, 4, 5)
  ),
  "v_212" = list(
    "CH" = c(1),
    "C" = c(2),
    "Autre" = c(3, 4, 5, 6)
  )
)

data <- regroup_data(data, regrouping_dict)
```

## New variables
This code block creates new variable in the dataset. For example one of the new questions tells if the user uses their personal car often or not.
```{r}
data[["v_600"]] <- haven::labelled(
  ifelse(data$v_328 %in% c(1, 2), 1, 0),
  labels = c("Utilisation fréquente" = 1, "Utilisation non fréquente" = 0),
  label = "Utilisation de voiture personelle"
)

data[["v_601"]] <- haven::labelled(
  ifelse(data$v_208 %in% c(2, 3, 4), 1, 0),
  labels = c("Enfant(s)" = 1, "Pas d'enfant(s)" = 0),
  label = "Enfant(s)"
)
```

## Regroup special variables
This code block regroups special variables. Sometimes the question is the title of the page on the questionnaire. We regroup all of the variables on the page that has a question as a title to make their processing easier.
```{r}
data <- data |>
  dplyr::mutate(
    v_602 = ifelse(
      v_461 == 1, 4, ifelse(
        v_462 == 1, 3, ifelse(
          v_463 == 1, 2, ifelse(
            v_464 == 1, 1, ifelse(
              v_465 == 1, 0, -99
            )
          )
        )
      )
    )
  )

data[["v_602"]] <- haven::labelled(
  data[["v_602"]],
  labels = c("Je n'ai pas de places de stationnement privée" = 0, "Pas important" = 1, "Plutôt pas important" = 2, "Plutôt important" = 3, "Très important" = 4, "Pas de réponce" = -99),
  label = "À quel point est-il important pour vous d'avoir une place de stationnement privée ?"
)


groups <- list(
  c("v_42", "v_43", "v_44", "v_45", "v_46", "v_47", "v_48", "v_49", "v_50", "v_51", "v_52", "v_53", "v_54", "v_278", "v_277"),
  c("v_456", "v_457", "v_458", "v_459"),
  c("v_284", "v_289", "v_285", "v_286", "v_287", "v_288", "v_290"),
  c("v_317", "v_318", "v_319", "v_320", "v_321", "v_322", "v_323", "v_324", "v_325", "v_326", "v_327", "v_439", "v_440"),
  c("v_298", "v_299", "v_300", "v_301", "v_302", "v_303", "v_304", "v_305", "v_306"),
  c("v_308", "v_309", "v_310", "v_311", "v_312", "v_313", "v_314"),
  c("v_179", "v_180", "v_181", "v_184", "v_185"),
  c("v_70", "v_71", "v_72", "v_73", "v_242", "v_271", "v_272", "v_273", "v_274", "v_275", "v_276"),
  c("v_328", "v_329", "v_330", "v_331", "v_332", "v_333", "v_334"),
  c("v_427", "v_428", "v_429", "v_430", "v_431"),
  c("v_339", "v_340", "v_341", "v_343"),
  c("v_345", "v_346", "v_347", "v_348", "v_350"),
  c("v_352", "v_353"),
  c("v_357", "v_358", "v_359"),
  c("v_362", "v_363"),
  c("v_367", "v_368", "v_369", "v_370", "v_371", "v_372"),
  c("v_131", "v_132", "v_133", "v_135"),
  c("v_196", "v_197", "v_198", "v_199", "v_200", "v_201", "v_202", "v_203", "v_264", "v_265", "v_266", "v_267", "v_268", "v_269", "v_270"),
  c("v_461", "v_462", "v_463", "v_464", "v_465"),
  c("v_74", "v_76", "v_78", "v_80", "v_82", "v_114", "v_122"),
  c("v_379", "v_380", "v_381", "v_382", "v_383"),
  c("v_391", "v_392", "v_393", "v_394", "v_395"),
  c("v_397", "v_398", "v_399", "v_400", "v_401"),
  c("v_403", "v_404", "v_405", "v_406", "v_407"),
  c("v_409", "v_410", "v_411", "v_412", "v_413"),
  c("v_415", "v_416", "v_417", "v_418", "v_419"),
  c("v_421", "v_422", "v_423", "v_424", "v_425"),
  c("v_154", "v_156", "v_158", "v_433", "v_435"),
  c("v_164", "v_166", "v_168")
)

data <- regroup_special(data, groups)
```

## Unlabeled variables
This code block adds label to unlabeled variables.
```{r}
logement_list = c("v_68", "v_69", "v_70", "v_71", "v_271", "v_242", "v_72", "v_73", "v_272", "v_273", "v_274", "v_275", "v_276")
for (name in logement_list) {
  data[[name]] <- haven::labelled(
    data[[name]],
    label = paste0("Pensez à votre logement et évaluez votre satisfaction selon ce critère: ", attr(data[[name]], "label")),
    labels = c("Très satisfaite / Très satisfait" = 1, "Plutôt satisfaite / Plutôt satisfait" = 2, "Peu satisfaite / Peu satisfait" = 3, "Pas du tout satisfaite / Pas du tout satisfait" = 4, "Pas d'avis" = 5)
  )
}


for (i in 328:334) {
  name = paste0("v_", i)
  data[[name]] <- haven::labelled(
    data[[name]],
    label = paste0("À quelle fréquence utilisez-vous ce moyen de déplacement: ", attr(data[[name]], "label")),
    labels = c("Tous les jours ou presque" = 1, "Quelques jours par semaine" = 2, "Quelques jours par mois" = 3, "Quelques jours par année" = 4, "Jamais" = 5)
  )
}
```

## Save regrouped data
This code block saves this new regrouped dataset to a new file in the processed data folder.
```{r}
if (!dir.exists(processed_data_folder)) {
  dir.create(processed_data_folder, recursive = TRUE)
}

haven::write_sav(data, file.path(processed_data_folder, "regrouped_data.sav"))
```
